#!/usr/bin/env ruby

require 'superstacker'
require 'thor'
require 'diffy'

module Cli
  class Template < Thor

    desc 'compile DIR', 'Compile the SuperStacker template in DIR.'
    def compile(dir)
      stack = ::SuperStacker::Stack.stack_from_dir(dir)
      puts stack[:template]
    end

    desc 'compare A B', 'Compare stacks A and B and report on differences.'
    def compare(a, b)
      sa = ::SuperStacker::Stack::resolve_stack(a)
      sb = ::SuperStacker::Stack::resolve_stack(b)

      puts '-' * 35 + ' TEMPLATE ' + '-' * 35
      puts Diffy::Diff.new(sa[:template], sb[:template]).to_s(:color)

      unless sa[:params].nil? || sb[:params].nil?
        puts '-' * 34 + ' PARAMETERS ' + '-' * 34
        puts Diffy::Diff.new(sa[:params], sb[:params]).to_s(:color)
      end
    end
  end

  class SuperStacker < Thor

    desc 'template SUBCOMMAND',
      'superstacker commands related to cloudformation templates'
    subcommand :template, Template

  end
end

Cli::SuperStacker.start(ARGV)
